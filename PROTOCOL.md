# SNMP 协议说明

## SNMP 协议基础

### 协议特性
- **传输协议**: UDP (用户数据报协议)
- **端口号**: 161 (SNMP Agent) 和 162 (SNMP Trap)
- **版本**: 支持 SNMPv1, SNMPv2c, SNMPv3
- **本项目使用**: SNMPv2c

### 为什么SNMP使用UDP？

1. **低开销**: UDP是无连接协议，开销小，适合网络管理的频繁查询
2. **简单性**: 不需要建立连接，简化了网络管理的复杂性
3. **实时性**: 没有TCP的连接建立和维护开销，响应更快
4. **广播支持**: UDP支持广播，便于网络发现

### 重要提示

#### ❌ 错误的测试方法
```bash
# 这些命令会失败，因为SNMP使用UDP，不是TCP
telnet 192.168.1.1 161
Test-NetConnection 192.168.1.1 -Port 161
nc -z 192.168.1.1 161
```

#### ✅ 正确的测试方法
```bash
# 使用SNMP工具测试
snmpwalk -v2c -c public 192.168.1.1 1.3.6.1.2.1.1.1.0

# 使用我们的测试工具
go run cmd/test_snmp.go 192.168.1.1

# 使用专门的UDP端口测试工具
nmap -sU -p 161 192.168.1.1
```

## SNMP 操作类型

### GET 操作
获取单个或多个OID的值
```go
result, err := gosnmp.Get([]string{"1.3.6.1.2.1.1.1.0"})
```

### WALK 操作
遍历OID树的一个分支
```go
result, err := gosnmp.WalkAll("1.3.6.1.2.1.2.2.1.2")
```

### BULK WALK 操作
批量获取OID数据（更高效）
```go
result, err := gosnmp.BulkWalkAll("1.3.6.1.2.1.2.2.1.2")
```

## 常用 OID

### 系统信息
- **1.3.6.1.2.1.1.1.0**: 系统描述
- **1.3.6.1.2.1.1.3.0**: 系统运行时间
- **1.3.6.1.2.1.1.5.0**: 系统名称

### 接口信息
- **1.3.6.1.2.1.2.1.0**: 接口数量
- **1.3.6.1.2.1.2.2.1.1**: 接口索引
- **1.3.6.1.2.1.2.2.1.2**: 接口描述
- **1.3.6.1.2.1.31.1.1.1.1**: 接口名称

### MAC地址表（Bridge MIB）
- **1.3.6.1.2.1.17.4.3.1.1**: FDB MAC地址
- **1.3.6.1.2.1.17.4.3.1.2**: FDB端口号
- **1.3.6.1.2.1.17.1.4.1.2**: 桥接端口到接口索引映射

### ARP表
- **1.3.6.1.2.1.4.22.1.1**: ARP接口索引
- **1.3.6.1.2.1.4.22.1.2**: ARP MAC地址
- **1.3.6.1.2.1.4.22.1.3**: ARP IP地址

## 网络诊断

### 连通性测试
1. **基础连通性**: `ping <IP>`
2. **SNMP响应**: `snmpwalk -v2c -c <community> <IP> 1.3.6.1.2.1.1.1.0`
3. **UDP端口扫描**: `nmap -sU -p 161 <IP>`

### 常见问题诊断

#### 连接超时
- 检查防火墙设置（UDP 161端口）
- 验证SNMP community字符串
- 确认设备SNMP服务状态

#### 权限错误
- 检查SNMP community配置
- 验证SNMP访问控制列表（ACL）
- 确认SNMP版本兼容性

#### 数据获取失败
- 检查OID是否存在
- 验证设备是否支持特定MIB
- 确认网络延迟和超时设置

## 安全考虑

### SNMPv2c 安全性
- **Community字符串**: 相当于密码，以明文传输
- **默认Community**: "public"（只读）, "private"（读写）
- **生产环境**: 必须更改默认community字符串

### 最佳实践
1. **使用复杂的community字符串**
2. **限制SNMP访问源IP**
3. **只开启必要的SNMP功能**
4. **定期监控SNMP访问日志**
5. **考虑升级到SNMPv3**（支持加密和认证）

## 故障排除流程

1. **网络连通性**: `ping <target_ip>`
2. **SNMP基础测试**: `snmpwalk -v2c -c <community> <target_ip> 1.3.6.1.2.1.1.1.0`
3. **检查防火墙**: 确保UDP 161端口开放
4. **验证配置**: 检查community、版本、超时设置
5. **设备状态**: 确认目标设备SNMP服务正常

记住：**SNMP是UDP协议，不要用TCP工具测试！**